from flask import Flask, request, redirect, url_for
from flask_login import LoginManager, UserMixin, login_user, login_required, logout_user
from flask_ldap3_login import LDAP3LoginManager

app = Flask(__name__)
app.secret_key = 'supersecretkey'

# LDAP Config
app.config['LDAP_HOST'] = '{{ ldap_host }}'
app.config['LDAP_BASE_DN'] = 'dc=sk,dc=com'
app.config['LDAP_USER_DN'] = 'ou=users'
app.config['LDAP_GROUP_DN'] = 'ou=groups'
app.config['LDAP_USER_RDN_ATTR'] = 'cn'
app.config['LDAP_BIND_USER_DN'] = 'cn=admin,dc=sk,dc=com'
app.config['LDAP_BIND_USER_PASSWORD'] = '{{ ldap_password }}'

ldap_manager = LDAP3LoginManager(app)
login_manager = LoginManager(app)

class User(UserMixin):
    def __init__(self, username, data):
        self.id = username
        self.data = data

users = {}

@login_manager.user_loader
def load_user(user_id):
    return users.get(user_id)

@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        username = request.form['username']
        password = request.form['password']
        result = ldap_manager.authenticate(username, password)
        if result.status:
            user = User(username, result.user_info)
            users[username] = user
            login_user(user)
            return redirect(url_for('protected'))
        else:
            return "Invalid credentials", 401
    return '''
    <form method="post">
      Username: <input name="username"><br>
      Password: <input type="password" name="password"><br>
      <input type="submit">
    </form>
    '''

@app.route('/protected')
@login_required
def protected():
    return "Hello, you are authenticated via LDAP!"

@app.route('/logout')
@login_required
def logout():
    logout_user()
    return "Logged out"

if __name__ == "__main__":
    app.run(host='0.0.0.0', port=5000)

